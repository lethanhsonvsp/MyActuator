@page "/"
@using MudBlazor
@using MyActuator.Services
@using System.Threading.Tasks
@inject MotorControlService MotorService
@implements IDisposable
@rendermode InteractiveServer

<MudThemeProvider IsDarkMode="true" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">

    <!-- CONNECTION PANEL -->
    <MudPaper Elevation="3" Class="pa-2 mb-2">
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudTextField @bind-Value="_canInterface"
                              Label="CAN Interface"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Cable" />
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudNumericField @bind-Value="_motorId"
                                 Label="Motor ID"
                                 Variant="Variant.Outlined"
                                 Min="1" Max="32"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Tag"
                                 T="byte" />
            </MudItem>
            <MudItem xs="12" sm="5" Class="d-flex align-center">
                @if (!MotorService.IsConnected)
                {
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Link"
                               OnClick="Connect"
                               FullWidth="true">
                        Connect
                    </MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Error"
                               StartIcon="@Icons.Material.Filled.LinkOff"
                               OnClick="Disconnect"
                               FullWidth="true">
                        Disconnect
                    </MudButton>
                }
            </MudItem>
        </MudGrid>

        <MudAlert Severity="@GetConnectionSeverity()" Class="mt-3" Dense="true">
            @MotorService.ConnectionStatus
        </MudAlert>

        @if (!string.IsNullOrEmpty(MotorService.ErrorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-2" Dense="true">
                @MotorService.ErrorMessage
            </MudAlert>
        }
    </MudPaper>

    <!-- STATUS DISPLAY -->
    <MudPaper Elevation="3" Class="pa-2 mb-2">
        <MudText Typo="Typo.h5" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Dashboard" Class="mr-2" />
            Motor Status
        </MudText>

        <MudGrid>
            <MudItem xs="6" sm="3">
                <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(33, 150, 243, 0.1);">
                    <MudIcon Icon="@Icons.Material.Filled.Thermostat" Size="Size.Large" Color="Color.Info" />
                    <MudText Typo="Typo.h4">@MotorService.Temperature°C</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Info">Temperature</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" sm="3">
                <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(76, 175, 80, 0.1);">
                    <MudIcon Icon="@Icons.Material.Filled.ElectricBolt" Size="Size.Large" Color="Color.Success" />
                    <MudText Typo="Typo.h4">@MotorService.TorqueCurrent.ToString("F2") A</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Success">Current</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" sm="3">
                <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(255, 152, 0, 0.1);">
                    <MudIcon Icon="@Icons.Material.Filled.Speed" Size="Size.Large" Color="Color.Warning" />
                    <MudText Typo="Typo.h4">@MotorService.Speed dps</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Warning">Speed</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" sm="3">
                <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(156, 39, 176, 0.1);">
                    <MudIcon Icon="@Icons.Material.Filled.RotateRight" Size="Size.Large" Color="Color.Secondary" />
                    <MudText Typo="Typo.h4">@MotorService.Angle°</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Angle</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- CONTROL PANELS -->
    <MudPaper Elevation="3" Class="pa-2 mb-2">

        <MudGrid>

            <!-- TORQUE CONTROL -->
            <MudItem xs="12" md="3">
                <MudPaper Elevation="0"
                          Class="pa-4 control-panel"
                          Style="height:100%;">

                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.Memory"
                                 Class="mr-2"
                                 Color="Color.Success" />
                        Torque
                    </MudText>

                    <MudNumericField @bind-Value="MotorService.TargetTorque"
                                     Label="Torque (A)"
                                     Variant="Variant.Outlined"
                                     Min="-10" Max="10"
                                     Format="F2"
                                     T="float"
                                     FullWidth
                                     Class="mb-3" />

                    <MudSlider @bind-Value="MotorService.TargetTorque"
                               Min="-10" Max="10"
                               Color="Color.Success"
                               T="float"
                               Class="mb-3" />

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Success"
                               OnClick="MotorService.SendTorqueCommandAsync"
                               Disabled="!MotorService.IsConnected"
                               FullWidth>
                        Send
                    </MudButton>

                </MudPaper>
            </MudItem>

            <!-- VELOCITY CONTROL -->
            <MudItem xs="12" md="3">
                <MudPaper Elevation="0"
                          Class="pa-4 control-panel"
                          Style="height:100%;">

                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.Speed"
                                 Class="mr-2"
                                 Color="Color.Warning" />
                        Velocity
                    </MudText>

                    <MudNumericField @bind-Value="MotorService.TargetSpeed"
                                     Label="Speed (dps)"
                                     Variant="Variant.Outlined"
                                     Min="-1000" Max="1000"
                                     T="int"
                                     FullWidth
                                     Class="mb-3" />

                    <MudSlider @bind-Value="MotorService.TargetSpeed"
                               Min="-1000" Max="1000"
                               Color="Color.Warning"
                               T="int"
                               Class="mb-3" />

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Warning"
                               OnClick="MotorService.SendVelocityCommandAsync"
                               Disabled="!MotorService.IsConnected"
                               FullWidth>
                        Send
                    </MudButton>

                </MudPaper>
            </MudItem>
            <!-- POSITION CONTROL -->
            <MudItem xs="12" md="3">
                <MudPaper Elevation="0"
                          Class="pa-4 control-panel"
                          Style="height:100%;">

                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.RotateRight"
                                 Class="mr-2"
                                 Color="Color.Secondary" />
                        Position
                    </MudText>

                    <MudNumericField @bind-Value="MotorService.TargetAngle"
                                     Label="Angle (°)"
                                     Variant="Variant.Outlined"
                                     Min="-360" Max="360"
                                     T="float"
                                     FullWidth
                                     Class="mb-2" />

                    <MudNumericField @bind-Value="MotorService.MaxSpeed"
                                     Label="Max Speed (dps)"
                                     Variant="Variant.Outlined"
                                     Min="10" Max="1000"
                                     T="ushort"
                                     FullWidth
                                     Class="mb-3" />

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               OnClick="MotorService.SendPositionCommandAsync"
                               Disabled="!MotorService.IsConnected"
                               FullWidth>
                        Send
                    </MudButton>

                </MudPaper>
            </MudItem>
            <!-- ACC / DEC CONTROL -->
            <MudItem xs="12" md="3">
                <MudPaper Elevation="0"
                          Class="pa-4 control-panel"
                          Style="height:100%;">

                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp"
                                 Class="mr-2"
                                 Color="Color.Info" />
                        Acc / Dec
                    </MudText>

                    <MudNumericField @bind-Value="MotorService.PositionAcc"
                                     Label="Acc (dps/s)"
                                     Variant="Variant.Outlined"
                                     Min="100" Max="60000"
                                     T="uint"
                                     FullWidth
                                     Class="mb-2" />

                    <MudNumericField @bind-Value="MotorService.PositionDec"
                                     Label="Dec (dps/s)"
                                     Variant="Variant.Outlined"
                                     Min="100" Max="60000"
                                     T="uint"
                                     FullWidth
                                     Class="mb-3" />

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Info"
                               OnClick="MotorService.ApplyPositionAccDecAsync"
                               Disabled="!MotorService.IsConnected"
                               FullWidth>
                        Apply
                    </MudButton>

                </MudPaper>
            </MudItem>

        </MudGrid>

    </MudPaper>

    <!-- ================= AUTO + EMERGENCY | LOG ================= -->
    <MudGrid>

        <!-- LEFT -->
        <MudItem xs="12" md="6" Style="max-height:38vh; overflow:hidden">

            <MudPaper Class="pa-3 mb-2" Elevation="3">
                <MudText Typo="Typo.subtitle1">Auto Loop</MudText>

                <MudGrid>
                    <MudItem xs="4">
                        <MudNumericField @bind-Value="MotorService.AutoAngle" Label="±deg" T="float" FullWidth />
                    </MudItem>
                    <MudItem xs="4">
                        <MudNumericField @bind-Value="MotorService.AutoLoops" Label="Loops" T="int" FullWidth />
                    </MudItem>
                    <MudItem xs="4">
                        <MudNumericField @bind-Value="MotorService.AutoDelayMs" Label="Delay ms" T="int" FullWidth />
                    </MudItem>
                </MudGrid>

                <MudGrid Class="mt-2">
                    <MudItem xs="6">
                        <MudButton FullWidth Color="Color.Info"
                                   OnClick="MotorService.StartAutoLoopAsync"
                                   Disabled="!MotorService.IsConnected || MotorService.IsAutoRunning">
                            Start
                        </MudButton>
                    </MudItem>
                    <MudItem xs="6">
                        <MudButton FullWidth Color="Color.Error"
                                   OnClick="MotorService.StopAutoLoopAsync"
                                   Disabled="!MotorService.IsAutoRunning">
                            Stop
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <MudPaper Class="pa-3" Elevation="3">
                <MudText Typo="Typo.subtitle1">Emergency</MudText>

                <MudGrid>
                    <MudItem xs="4">
                        <MudButton FullWidth Color="Color.Warning"
                                   OnClick="MotorService.StopMotorAsync">
                            Stop
                        </MudButton>
                    </MudItem>
                    <MudItem xs="4">
                        <MudButton FullWidth Color="Color.Error"
                                   OnClick="MotorService.ShutdownMotorAsync">
                            Shutdown
                        </MudButton>
                    </MudItem>
                    <MudItem xs="4">
                        <MudButton FullWidth Color="Color.Info"
                                   OnClick="MotorService.ResetMotorAsync">
                            Reset
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>

        </MudItem>

        <!-- RIGHT LOG -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-3" Elevation="3">
                <MudText Typo="Typo.subtitle1">Activity Log</MudText>

                <MudPaper Class="pa-2"
                          Style="background:#1e1e1e;
                                 height:calc(100vh - 735px);
                                 min-height:120px;
                                 overflow:auto;
                                 font-family:monospace;">
                    @foreach (var log in MotorService.Logs.TakeLast(50).Reverse())
                    {
                        <div style="color:#dcdcdc">@log</div>
                    }
                </MudPaper>
            </MudPaper>
        </MudItem>

    </MudGrid>

</MudContainer>

@code {
    private string _canInterface = "can0";
    private byte _motorId = 1;

    protected override void OnInitialized()
    {
        MotorService.OnStateChanged += OnMotorServiceStateChanged;
    }

    private Task OnMotorServiceStateChanged()
    {
        return InvokeAsync(StateHasChanged);
    }

    private async Task Connect()
    {
        await MotorService.ConnectAsync(_canInterface, _motorId);
    }

    private async Task Disconnect()
    {
        await MotorService.DisconnectAsync();
    }

    private Severity GetConnectionSeverity()
    {
        if (MotorService.IsConnected)
            return Severity.Success;
        else if (MotorService.ConnectionStatus.Contains("Failed") || MotorService.ConnectionStatus.Contains("Error"))
            return Severity.Error;
        else
            return Severity.Info;
    }

    public void Dispose()
    {
        MotorService.OnStateChanged -= OnMotorServiceStateChanged;
    }
}

<style>

    .control-panel {
        background: transparent !important;
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 12px;
    }

</style>